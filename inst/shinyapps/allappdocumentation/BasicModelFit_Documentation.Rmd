---
title: Basic Model Fit 
output:
  html_document:
    theme: null
    highlight: null
    css: ../styles/dsairm.css
    fig_caption: true
    mathjax: default 
    keep_md: false
    includes:
      #in_header: in_header.txt
      before_body: ../styles/dsairm_before_body.txt
      after_body: ../styles/dsairm_after_body.txt 
bibliography: ../media/references.bib
---

##Overview {#shinytab1}
This app illustrates how to fit a mechanistic dynamical model to data and how to use simulated data to evaluate if it is possible to fit a specific model.


##The Model {#shinytab2}

###Data
For this app, viral load data from patients infected with influenza is being fit. The data is average log viral titer on days 1-8 post infection. The data comes from [@hayden96], specifically the 'no treatment' group shown in Figure 2 of this paper.

Another source of 'data' is by using our simulation to produce artificial data.

###Simulation Model 
The underlying model that is being fit to the data is the basic virus model used in the app of this name. See that app for a description of the model.


###Fitting Model
This app fits the log viral titer of the data to the virus kinetics produced by the model simulation. The fit is evaluated by computing the sum of square errors between data and model for all data points, i.e.
$$
SSR= \sum_t (Vm_t - Vd_t)^2
$$
where $Vm_t$ is the virus load (in log units) predicted from the model simulation at days $t=1..8$ and $Vd_t$ is the data, reported in those units and on those time points. The underlying code varies model parameters to try to get the predicted viral load from the model as close as possible to the data, by minimizing the SSR. The app reports the final SSR for the fit. 

In general, with enough data, one could fit/estimate every parameter in the model and the initial conditions. However, with just the virus load data available, the data are not rich enough to allow estimation of all model parameters (even for a model as simple as this). The app is therefore implemented by assuming that most model parameters are known and fixed, and only 3, the rate of virus production, _p_, the rate of infection of cells, _b_, and the rate of virus death/removal, _d~V~_ can be estimated. The app also allows to keep some of those parameters fixed, we'll explore this in the tasks.


##What to do {#shinytab3}

The model is assumed to run in units of days.

###Task 1 
* Start with 10^6^ uninfected cells, no infected cells, 10 virions.
* No uninfected cell birth and deaths, lifespan of infected cells 12 hours, unit conversion 1.
* For the parameter that are fit, set virus production rate to 10, infection rate to 10^-6^ and virus decay rate to 4. These parameters are being fit, the values we specify here are the starting conditions for the optimizer. 
* Set all "fitted" switches to YES to make sure the parameters are being fit. For each parameter, choose some lower and upper bounds. Note that if the lower bound is not lower/equal and the upper not higher/equal than the parameter, you will get an error message when you try to run the model.
* Ignore the values for simulated data for now, set "fit to simulated data" to NO. 
* Start with a 100 fitting iterations and solver type 1. Run the simulation, it will take some time.
* Look at the results. The plot shows the final fit. It will be poor, i.e. the model virus load curve will not be close to the data. You will also see the values of the 'best fit' parameters. Since this is a bad fit, these values are not meaningful yet. We'll get to that below.

###Task 2 
* Switch around the solvers/optimizers to use for fitting, run each for 100 iterations. They will provide different fits but none will be good.
* Increase number of iterations to 200 or 500 or 1000. This will take more time to run. Results should get better.

FITTING NOT WORKING ON REAL DATA, NEED TO DEBUG/RESOLVE

##Further Information {#shinytab4}
* The code running the model fitting is in the function/script `simulate_fitbasicmodel.R`. This function repeatedly calls the underlying simulation model encoded in `simulate_basicvirus.R` during the fitting. Check the help file for both functions to see how to use them.
* 

### References


